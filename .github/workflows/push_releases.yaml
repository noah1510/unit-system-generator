on:
  workflow_call:
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      MESON_DEPLOY_KEY:
        required: true
      ARDUINO_DEPLOY_KEY:
        required: true

jobs:
  upload_matrix:
    runs-on: "ubuntu-22.04"
    strategy:
      fail-fast: false
      matrix:
        generateArgs:
          - name: "meson"
            args: ""
            repo: "git@github.com:noah1510/unit-system.git"
          - name: "arduino"
            args: "--arduino"
            repo: "git@github.com:noah1510/unit-system-adruino.git"
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
        with:
          python-version: "3.11"
          cache: "pipenv"
      - name: install pipenv
        run: pip install pipenv
      - name: install script deps
        run: pipenv install
      - name: generate sources
        run: pipenv run python3 ./genSources.py ${{ matrix.generateArgs.args }} -o output
      - name: put the meson ssh key to env
        if: ${{ matrix.generateArgs.name == 'meson' }}
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "ssh_key<<$EOF" >> "$GITHUB_ENV"
          echo "${{ secrets.MESON_DEPLOY_KEY }}" >> "$GITHUB_ENV"
          echo "$EOF" >> "$GITHUB_ENV"
      - name: put the arduino ssh key to env
        if: ${{ matrix.generateArgs.name == 'arduino' }}
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "ssh_key<<$EOF" >> "$GITHUB_ENV"
          echo "${{ secrets.ARDUINO_DEPLOY_KEY }}" >> "$GITHUB_ENV"
          echo "$EOF" >> "$GITHUB_ENV"
      - name: commit and push changes to ${{ matrix.generateArgs.name }}
        if: ${{ github.ref_type == 'branch'}}
        uses: s0/git-publish-subdir-action@master
        env:
          REPO: ${{ matrix.generateArgs.repo }}
          BRANCH: ${{ github.ref_name }}
          FOLDER: output
          SSH_PRIVATE_KEY: ${{ env.ssh_key }}
      - name: commit and push changes to ${{ matrix.generateArgs.name }}
        if: ${{ github.ref_type != 'branch' }}
        uses: s0/git-publish-subdir-action@master
        env:
          REPO: ${{ matrix.generateArgs.repo }}
          BRANCH: main
          FOLDER: output
          SSH_PRIVATE_KEY: ${{ env.ssh_key }}
          TAG: ${{ github.ref_name }}